<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DimSim - a phosphene simulator for mobile phones</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1f00d0beadf87bad7d275c174616e048f8b573fc/dist/aframe-master.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script>
      const PHOSPHENE_STIM_DURATION = 100; //in ms. TODO: Simulate phosphene decay?

      const STIM_EVENT_NAME = 'stim'
      const stimEvent = new Event(STIM_EVENT_NAME);

      AFRAME.registerPrimitive('a-phosphene', {
        defaultComponents: {
          geometry: { primitive: 'circle', radius: '0.1' },
          material: { src:'phosphene-texture2.png', color: 'white', opacity: '1' },
          animation__noConnection: { property:'material.opacity', from: -1, to: 1, dur: 3000, dir: 'alternate', easing: 'easeInOutSine', loop: true, enabled: false },
          animation__stim: { property:'material.opacity', from: 0, to: 0, dur: PHOSPHENE_STIM_DURATION, dir: 'normal', loop: false, startEvents: STIM_EVENT_NAME, enabled: true },
          position: { x:0, y:0, z:-1 } // Assumes x-range -0.5 <= x <= 0.5, and y-range -0.4 <= y <= 0.4
        },

        mappings: {
          intensity: 'material.opacity',
          x: 'position.x',
          y: 'position.y',
          pulse: 'animation__noConnection.enabled'
        },
      })
    </script>
  </head>
  <body>
    <a-scene background="color:black">
      <a-entity camera look-controls="enabled: false; touchEnabled: false; magicWindowTrackingEnabled: false">
        <a-phosphene id="p10001" x="-0.3" y="0.15"></a-phosphene>
        <a-phosphene id="p10002" x="-0.3" y="-0.15"></a-phosphene>
        <a-phosphene id="p10003" x="-0.125" y="0"></a-phosphene>
        <a-phosphene id="p10004" x="0" y="0.25"></a-phosphene>
        <a-phosphene id="p10005" x="0" y="-0.25"></a-phosphene>
        <a-phosphene id="p10006" x="0.125" y="0"></a-phosphene>
        <a-phosphene id="p10007" x="0.3" y="0.15"></a-phosphene>
        <a-phosphene id="p10008" x="0.3" y="-0.15"></a-phosphene>
        <a-entity id="noConnectionLabel" position="-0.30 0.0 -1" text="anchor: left; width: 2; color: #BB3532; value: No connection..."></a-entity>
      </a-entity>
    </a-scene>
  </body>

  <script>
    function connect() {
      const ws = new WebSocket(`ws://${window.location.hostname}:8080`);

      ws.onmessage = (e) => { // Payload example format [{id: 10002, int: 0.2}, {id: 10005, int: 0.9}, {id: 10008, int: 0.2}, {id: 10001, int: 0}]
        const data = JSON.parse(e.data);
        data.forEach(x => {
          stimPhosphene(document.querySelector(`#p${x.id}`), x.int);
        })
      }

      ws.onopen = (e) => { // when the client connects
        console.log("Connection established.");
        showNoConnectionLabel(false);
        pulsePhosphenes(false);
        ws.send("Client is " + navigator.userAgent)
      }

      ws.onclose = (e) => { // when the client disconnects
        console.log("Connection lost...Retrying in 5s...");
        showNoConnectionLabel(true);
        pulsePhosphenes(true);
        setTimeout(() => { connect(); }, 5000)
      }
    }

    function stimPhosphene(phEl, intensity) {
      phEl.components.animation__stim.data.from = phEl.components.material.material.opacity; // set the start to the material's current opacity in case it's already in the middle of a tween
      phEl.components.animation__stim.data.to = intensity;
      phEl.dispatchEvent(stimEvent);
    }

    function pulsePhosphenes(shouldPulse) {
      document.querySelectorAll('a-phosphene').forEach(el => el.setAttribute('pulse', shouldPulse));
    }

    function showNoConnectionLabel(shouldShow) {
      document.querySelector("#noConnectionLabel").object3D.visible = shouldShow;
    }

    $(document).ready((e) => { 
      connect();
    });
  </script>
</html>