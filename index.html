<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DimSim - a phosphene simulator for mobile phones</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1f00d0beadf87bad7d275c174616e048f8b573fc/dist/aframe-master.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <script>
      const CONNECTION_RETRY_INTERVAL = 5000;
      const PHOSPHENE_STIM_DURATION = 100; //in ms.
      const PHOSPHENE_DECAY_DURATION = 400; //in ms.
      const MAP_8_DIAMOND = [ { id: 10001, x: -0.3, y: 0.15 }, { id: 10002, x: -0.3, y: -0.15 }, { id: 10003, x: -0.125, y: 0 }, { id: 10004, x: 0, y: 0.25 }, { id: 10005, x: 0, y: -0.25 }, { id: 10006, x: 0.125, y: 0 }, { id: 10007, x: 0.3, y: 0.15 }, { id: 10008, x: 0.3, y: -0.15 }];

      const STIM_EVENT_NAME = 'stim'
      const stimEvent = new Event(STIM_EVENT_NAME);

      const DECAY_EVENT_NAME = 'decay'
      const decayEvent = new Event(DECAY_EVENT_NAME);

      const PAUSEDECAY_EVENT_NAME = 'pause_decay';
      const pauseDecayEvent = new Event(PAUSEDECAY_EVENT_NAME);

      AFRAME.registerPrimitive('a-phosphene', {
        defaultComponents: {
          geometry: { primitive: 'circle', radius: '0.1' },
          material: { src: 'phosphene-texture2.png', color: 'white', opacity: '0' },
          animation__noConnection: { property: 'material.opacity', from: -1, to: 1, dur: 3000, dir: 'alternate', easing: 'easeInOutSine', loop: true, enabled: false },
          animation__stim: { property: 'material.opacity', from: 0, to: 0, dur: PHOSPHENE_STIM_DURATION, dir: 'normal', loop: false, startEvents: STIM_EVENT_NAME, enabled: true },
          animation__decay: { property: 'material.opacity', from: 1, to: 0, dur: PHOSPHENE_DECAY_DURATION, dir: 'normal', loop: false, startEvents: DECAY_EVENT_NAME, pauseEvents: PAUSEDECAY_EVENT_NAME, enabled: true},
          position: { x:0, y:0, z:-1 } // Assumes x-range -0.5 <= x <= 0.5, and y-range -0.4 <= y <= 0.4
        },

        mappings: {
          intensity: 'material.opacity',
          x: 'position.x',
          y: 'position.y',
          pulse: 'animation__noConnection.enabled'
        },
      })

      AFRAME.registerPrimitive('a-noconnectionlabel', {
        defaultComponents: {
          position: { x: -0.30, y: 0.0, z:-1.0 },
          text: { anchor: "left", width: "2", color: "#BB3532", value: "No connection..." }
        }
      })
    </script>
  </head>
  <body>
    <a-scene background="color:black">
      <a-entity camera look-controls="enabled: false; touchEnabled: false; magicWindowTrackingEnabled: false"></a-entity>
       <!-- Scene is dynamically generated from the specified map. -->
    </a-scene>
  </body>

  <script>
    function connect() {
      const ws = new WebSocket(`ws://${window.location.hostname}:8080`);

      ws.onmessage = (e) => { // Payload example format [{id: 10002, int: 0.2}, {id: 10005, int: 0.9}, {id: 10008, int: 0.2}, {id: 10001, int: 0}]
        const stimulated = JSON.parse(e.data);

        // anything that's unstimulated should decay. If it's already decaying it will be left to complete its decay.
        let unStimulated = MAP_8_DIAMOND.filter(x => stimulated.map(y => y.id).indexOf(x.id) == -1);
        unStimulated.forEach(x => {
          decayPhosphene(document.querySelector(`#p${x.id}`));
        })

        // anything that's to be stimulated needs to have its decay stopped and stimulation started
        stimulated.forEach(x => {
          stimPhosphene(document.querySelector(`#p${x.id}`), x.int);
        })

      }

      ws.onopen = (e) => { // when the client connects
        console.log("Connection established.");
        showNoConnectionLabel(false);
        pulsePhosphenes(false);
        ws.send("Client is " + navigator.userAgent)
      }

      ws.onclose = (e) => { // when the client disconnects
        console.log("Connection lost...Retrying in 5s...");
        showNoConnectionLabel(true);
        pulsePhosphenes(true);
        setTimeout(() => { connect(); }, CONNECTION_RETRY_INTERVAL)
      }
    }

    function stimPhosphene(phEl, intensity) {
      phEl.components.animation__stim.data.from = phEl.components.material.material.opacity; // set the start to the material's current opacity in case it's already in the middle of a tween
      phEl.components.animation__stim.data.to = intensity;
      phEl.dispatchEvent(pauseDecayEvent);
      phEl.dispatchEvent(stimEvent);
    }
    
    function decayPhosphene(phEl) {
      if (phEl.components.animation__decay.animationIsPlaying) { return; } // Currently decaying...Don't interrupt

      phEl.components.animation__decay.data.from = phEl.components.material.material.opacity; // set the start to the material's current opacity in case it's already in the middle of a tween
      phEl.dispatchEvent(decayEvent);
    }

    function pulsePhosphenes(shouldPulse) {
      document.querySelectorAll('a-phosphene').forEach(el => el.setAttribute('pulse', shouldPulse));
    }

    function showNoConnectionLabel(shouldShow) {
      document.querySelector("a-noconnectionlabel").object3D.visible = shouldShow;
    }

    function onStimComplete(e) {
      if (e.detail.name == 'animation__stim') {
        decayPhosphene(e.srcElement);
      }
    }

    function buildDisplayFromMap(map) {
      let scene = document.querySelector("a-entity");
      map.forEach(ph => {
        let o = document.createElement('a-phosphene');
        o.setAttribute("id", "p" + ph.id);
        o.setAttribute("x", ph.x);
        o.setAttribute("y", ph.y);
        o.addEventListener('animationcomplete', onStimComplete);
        scene.append(o);
      })
      scene.append(document.createElement('a-noconnectionlabel'));
    }

    $(document).ready((e) => { 
      buildDisplayFromMap(MAP_8_DIAMOND);
      connect();
    });
  </script>
</html>